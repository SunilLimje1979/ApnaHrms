{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timesheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Timesheet</h2>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-sm"><i class="bi bi-arrow-left"></i> Dashboard</a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link {% if active_view == 'my_timesheet' %}active{% endif %}" href="{% url 'timesheet_page' %}?view=my_timesheet">My Timesheet</a>
        </li>
        {% if team_members %}<!-- Only show this tab if the user has a team -->
        <li class="nav-item">
            <a class="nav-link {% if active_view == 'my_team' %}active{% endif %}" href="{% url 'timesheet_page' %}?view=my_team">My Team</a>
        </li>
        {% endif %}
    </ul>

    <!-- Tab Content -->
    <div>
        <!-- MY TIMESHEET CONTENT -->
        {% if active_view == 'my_timesheet' %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                My Tasks
                <a href="{% url 'TaskAdd' %}" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle"></i> Add New Task</a>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-2 align-items-end p-3 mb-3 bg-light rounded">
                    <input type="hidden" name="view" value="my_timesheet">
                    <div class="col-md-4"><label class="form-label">Date</label><input type="date" class="form-control" name="my_date" value="{{ filters.my_date }}"></div>
                    <div class="col-auto"><button type="submit" class="btn btn-info">View</button></div>
                </form>
                
                <!-- CORRECTED LINE 1 -->
                {% include 'hrms/partials/task_list_partial.html' with tasks=my_tasks is_manager_view=False %}

            </div>
        </div>
        {% endif %}

        <!-- MY TEAM CONTENT -->
        {% if active_view == 'my_team' %}
        <div class="row">
            <div class="col-md-4">
                <div class="card"><div class="card-header">Team Members</div>
                    <div class="list-group list-group-flush">
                        {% for member in team_members %}
                        <a href="{% url 'timesheet_page' %}?view=my_team&team_member_id={{ member.employee_id }}" class="list-group-item list-group-item-action {% if selected_team_member_id == member.employee_id %}active{% endif %}">
                            {{ member.full_name }}
                        </a>
                        {% empty %}
                        <div class="list-group-item">You have no team members assigned.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                {% if selected_team_member_id %}
                <div class="card">
                    <div class="card-header">Review Timesheet</div>
                    <div class="card-body">
                        <form method="GET" class="row g-2 align-items-end mb-3">
                            <input type="hidden" name="view" value="my_team">
                            <input type="hidden" name="team_member_id" value="{{ selected_team_member_id }}">
                            <div class="col-md-6"><label class="form-label">Date</label><input type="date" class="form-control" name="team_date" value="{{ filters.team_date }}"></div>
                            <div class="col-auto"><button type="submit" class="btn btn-info">View</button></div>
                        </form>

                        <!-- CORRECTED LINE 2 -->
                        {% include 'hrms/partials/task_list_partial.html' with tasks=selected_team_member_tasks.tasks is_manager_view=True %}

                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">Please select a team member from the list to view their timesheet.</div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
          <form id="rejectionForm" method="POST">
            {% csrf_token %}
            <div class="modal-header"><h5 class="modal-title">Rejection Reason</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <p>Please provide a reason for rejecting this task.</p>
              <textarea class="form-control" name="rejection_reason" rows="3" required></textarea>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-danger">Submit Rejection</button></div>
          </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Your existing modal script is perfect, no changes needed
var rejectionModal = document.getElementById('rejectionModal');
if (rejectionModal) {
    rejectionModal.addEventListener('show.bs.modal', function (event) {
        var form = rejectionModal.querySelector('#rejectionForm');
        form.action = event.relatedTarget.getAttribute('data-bs-reject-url');
    });
}
</script>
</body>
</html>